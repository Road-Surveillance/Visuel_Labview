# Vehicle and License Plate Detection Pipeline

## Overview

This Python code implements a detection pipeline based on a YOLOv5 model to detect vehicles and license plates in images. The script is designed for integration with LabVIEW. LabVIEW can call this script by passing an image file path, and then use the JSON output (detailed below) to overlay detections and access cropped images.

## How to Run
 
> [!CAUTION]
> Please Use **Python 3.9** !

1. **Virtual Environement**
   ```bash
   python -m venv venv
   ```
2. **Install Dependencies:**  
   ```bash
   pip install -r requirements.txt
   ```
3. **Install Dependencies:**  
   ```bash
   cd .\testing\
   ```
4. **Execution:**  
   You can run the script directly or call the function ```detect_and_export_json```
   
## Inner Workings

### 1. Image Loading and Preprocessing

- **Input:** The function accepts an image file path.
- **Loading:** The image is loaded using OpenCV.
- **Resizing:** The image is resized to a specified size (default is 640×640) while maintaining its aspect ratio. The resizing function adds necessary padding and translates the image so that it fits within the desired dimensions.
- **Color Conversion and Normalization:**  
  - The image is converted from BGR (OpenCV’s default) to RGB.  
  - The image data is transposed to match the expected format for the YOLO model (channel-first order).
  - The image is converted into a PyTorch tensor and normalized to the [0, 1] range.

### 2. Detection

- The preprocessed image is fed into a YOLOv5 model loaded from the provided weights (e.g., `object.pt`).
- **Non-Maximum Suppression:**  
  Detections are filtered using non-maximum suppression (NMS) to remove overlapping bounding boxes.
- **Detection Output:**  
  Each detection includes a label (such as "car" or "rectangle license plate"), a confidence score, and bounding box coordinates in the format `[x1, y1, x2, y2]`.

### 3. Postprocessing & Output Generation

- **Drawing and Cropping:**  
  For each detection (except those labeled "person"):
  - A bounding box is drawn on an annotated copy of the resized image.
  - The detected region is cropped from the image.
  - Cropped images are saved into the following folders:
    - **License plates:** Saved in the folder `LPs`
    - **Other vehicles:** Saved in the folder `Vehicle`
- **JSON Output Construction:**  
  A JSON object is constructed with:
  - `"annotated_image"`: Path to the annotated image (saved in the folder `out`)
  - `"detections"`: An array containing an entry for each detection. Each entry is a dictionary with the following keys:
    - `label`
    - `confidence`
    - `bbox` (list of four integers)
    - `crop_path` (the file path to the cropped image)
    - `detection_type` (either `"vehicle"` or `"license_plate"`)

### 4. Directory Management

At the start of the script execution, the following directories are removed (if they exist) and then recreated **one time only**:
- `LPs`
- `Vehicle`
- `out`
- `json_out`

This ensures that the output directories are empty and ready for use during testing.

### 5. LabVIEW Integration

- **Invocation:**  
  LabVIEW calls this script (using the LabVIEW Python Node or as an external process) by passing an image path.
- **JSON Output:**  
  The script returns a JSON string that includes:
  - The path to the annotated image.
  - A list of detection details (labels, confidence scores, bounding boxes, and crop paths).
- **Usage in LabVIEW:**  
  LabVIEW can parse the JSON (using its built-in JSON functions) and use this information to overlay detection boxes, display cropped images, or further integrate with other modules.

## Example JSON Output

Below is a sample JSON output generated by the script:

```json
{
  "annotated_image": "out\\a.jpg",
  "detections": [
    {
      "label": "car",
      "confidence": 0.9600232243537903,
      "bbox": [848, 827, 1233, 1065],
      "crop_path": "Vehicle\\a_vehicle_0.jpg",
      "detection_type": "vehicle"
    },
    {
      "label": "car",
      "confidence": 0.9491833448410034,
      "bbox": [943, 309, 1094, 441],
      "crop_path": "Vehicle\\a_vehicle_1.jpg",
      "detection_type": "vehicle"
    },
    {
      "label": "rectangle license plate",
      "confidence": 0.2456061989068985,
      "bbox": [1272, 351, 1279, 365],
      "crop_path": "LPs\\a_license_plate_42.jpg",
      "detection_type": "license_plate"
    }
    // ... additional detections ...
  ]
}
```
